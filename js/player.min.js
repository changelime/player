/*! GruntTest By pcwow789@gmail.com 2015-02-15 */
!function(){function a(){this.handlers={}}a.prototype={constructor:a,on:function(a,b){"undefined"==typeof this.handlers[a]&&(this.handlers[a]=[]),this.handlers[a].push(b)},emit:function(a){if(a.target||(a.target=this),this.handlers[a.type]instanceof Array)for(var b=this.handlers[a.type],c=0,d=b.length;d>c;c++)b[c](a)},removeHandler:function(a,b){if(this.handlers[a]instanceof Array)for(var c=this.handlers[a],d=0,e=c.length;e>d&&c[d]!==b;d++);c.splice(d,1)}},window.EventTarget=a}(),function(){function a(a){this.target=document.querySelector(a),this.inside=document.createElement("div"),this.flag=document.createElement("div"),this.inside.className="inside",this.flag.className="flag",this.target.appendChild(this.inside),this.target.appendChild(this.flag),this._fragtion=0,this._pressFlag=!1,this._lock=!1,this._addEventListener()}a.prototype=new EventTarget,a.prototype._addEventListener=function(){var a=this;this.target.addEventListener("mousedown",function(b){a._setPosition(b),a.emit({type:"pressBar",message:b})},!0),this.flag.addEventListener("mousedown",function(b){a._pressFlag||(a._pressFlag=!0,a.emit({type:"startDraggingFlag",message:b}))},!1),document.addEventListener("mousemove",function(b){a._pressFlag&&(a._setPosition(b),a.emit({type:"draggingFlag",message:b}))},!1),document.addEventListener("mouseup",function(b){a._pressFlag&&(a._pressFlag=!1,a.emit({type:"stopDraggingFlag",message:b}))},!1)},a.prototype._setPosition=function(a,b){if(!this._lock){var c=this.target.offsetWidth;if(b){var d=6/c;return this.inside.style.width=100*b+"%",this.flag.style.left=100*(b-d)+"%",void(this._fragtion=b)}var e=a.clientX-this.target.offsetLeft;0>=e||e>c||(this._fragtion=e/c,this.inside.style.width=100*this._fragtion+"%",this.flag.style.left=(e-6)/c*100+"%",console.log(this._fragtion,e))}},a.prototype.setPosition=function(a){1>=a&&a>=0&&this._setPosition(null,a)},a.prototype.lock=function(){this._lock=!0},a.prototype.unlock=function(){this._lock=!1},a.prototype.getPosition=function(){return this._fragtion},window.Progressbar=a}(),function(){function a(a,b,c){this._db=null,this._connect=null,this._set=a,this._store={},this._upgradeneeded=b,this._space=a.space,this.callback=c,this._connectDB()}a.prototype._connectDB=function(){var a=this._set,b=this;this._connect=indexedDB.open(a.dbName,a.version),this._connect.onsuccess=function(a){b._db=a.target.result;for(var c=b._space,d=0;d<c.length;d++)!function(a){b[a]={get:function(c,d){b._getStore(a);var e=b._store[a].get(c);e.onsuccess=function(a){var b=a.target.result;b?d(null,b):d(new Error("not found"))}},add:function(c,d){b._getStore(a);var e=b._store[a].add(c);e.onsuccess=function(a){d(null,a)},e.onerror=function(a){d(new Error(a))}},"delete":function(c,d){b._getStore(a),this.get(c,function(e){if(e)d(new Error("not found"));else{var f=b._store[a]["delete"](c);f.onsuccess=function(a){d(null,a)}}})},put:function(c,d){b._getStore(a);var e=b._store[a].put(c);e.onsuccess=function(a){d(null,a)},e.onerror=function(a){d(new Error(a))}},getAll:function(c){b._getStore(a);var d=[],e=b._store[a].openCursor();e.onsuccess=function(a){var b=a.target.result;b?(d.push(b.value),b["continue"]()):c(d)}}},a==c[c.length-1]&&b.callback()}(c[d])},this._connect.onupgradeneeded=function(a){if(!b._upgradeneeded)throw new Error("upgradeneeded undefined");b._db=a.target.result,b._upgradeneeded(b._db)}},a.prototype._getStore=function(a){var b=this._set;this._store[a]=this._db.transaction(a,b.authority).objectStore(a)},window.Indexing=a}(),function(){var a=function(a){var b=document.getElementsByClassName("inside")[0],c=document.getElementsByClassName("flag")[0],d=document.getElementById("left"),e=document.getElementById("color");b.style.backgroundColor=a.themeColor,c.style.backgroundColor=a.themeColor,d.style.backgroundColor=a.themeColor,e.value=a.themeColor},b=null,c=function(){list=document.getElementById("list").childNodes;for(var a=0;a<list.length;a++)list[a].className="";console.log(b()),list.length>0&&(list[b()].className="playing")},d=function(a){listDom=document.getElementById("list"),listDom.innerHTML="";for(var b=0;b<a.length;b++){var d=document.createElement("li");d.innerText=a[b].name,listDom.appendChild(d)}c()},e=function(a,b){for(var c=0;c<a.length;c++)a[c].addEventListener("click",b)},f=null,g=function(a,b){var c=document.getElementById("changeMode");if(b)switch(a){case"repeatAll":c.title="列表循环",c.className="glyphicon glyphicon-retweet";break;case"random":c.title="随机播放",c.className="glyphicon glyphicon-random";break;case"repeat":c.title="单曲循环",c.className="glyphicon glyphicon-record"}else switch(a){case"repeatAll":f("random"),c.title="随机播放",c.className="glyphicon glyphicon-random";break;case"random":f("repeat"),c.title="单曲循环",c.className="glyphicon glyphicon-record";break;case"repeat":f("repeatAll"),c.title="列表循环",c.className="glyphicon glyphicon-retweet"}},h=function(c){var e={},h={},i={name:"default",themeColor:"#41A868",mode:"repeatAll",spectrum:!0,playing:0},j=new Indexing({dbName:"player",version:1,space:["files","setting"],authority:"readwrite"},function(a){a.createObjectStore("files",{keyPath:"name"}),a.createObjectStore("setting",{keyPath:"name"})},function(){h.getThemeColor=function(){return i.themeColor},h.setThemeColor=function(b){i.themeColor=b,j.setting.put(i,function(b,c){b||(a(i),console.log("setThemeColor success",c))})},h.getMode=function(){return i.mode},h.setMode=function(a){i.mode=a,j.setting.put(i,function(a,b){a||console.log("setMode success",b)})},h.getSpectrum=function(){return i.spectrum},h.setSpectrum=function(){i.spectrum=!i.spectrum,j.setting.put(i,function(a,b){a||console.log("setSpectrum success",b)})},h.getPlaying=function(){return i.playing},h.setPlaying=function(a){i.playing=a,j.setting.put(i,function(a,b){a||console.log("setPlaying success",b)})},f=h.setMode,b=h.getPlaying;var k=2,l=function(){0==--k&&c()};j.setting.get("default",function(b,c){b?j.setting.add(i,function(b,c){a(i),l(),console.log("初始化设置",c)}):(i.themeColor=c.themeColor,i.mode=c.mode,i.spectrum=c.spectrum,i.playing=c.playing,a(i),g(i.mode,!0),l())}),j.files.getAll(function(a){e.files=a,e.filesIndex={};for(var b=0;b<e.files.length;b++)e.filesIndex[e.files[b].name]=b;e.getByIndex=function(a){return e.files[a]},e.getByName=function(a){return{value:e.files[e.filesIndex[a]],index:e.filesIndex[a]}},e.getByRandom=function(){var a=Math.round(Math.random()*e.files.length+Date.now())%e.files.length;return{value:e.files[a],index:a}},e.getLength=function(){return e.files.length},e.add=function(a,b){j.files.get(a.name,function(c){c?j.files.add(a,function(){e.files.push(a),e.filesIndex[a.name]=e.files.length-1,d(e.files),b(),console.log("add success",e.files.length)}):console.log("already has")})},e.removeByIndex=function(a){j.files["delete"](e.files[a].name,function(b){b||(delete e.filesIndex[e.files[a].name],e.files.splice(a,1),d(e.files),console.log("remove success"))})},e.removeByName=function(a){j.files["delete"](a,function(b){b||(e.files.splice(e.filesIndex[a],1),delete e.filesIndex[a],d(e.files),console.log("remove success"))})},d(e.files),l()})});return{music:e,setting:h}};window.load=h,window.setMode=g,window.playingItemInList=c,window.addListeners=e}(),function(){var a=document.getElementById("left"),b=document.getElementById("setting"),c=document.getElementById("list"),d=-a.offsetWidth,e=!1;a.style.left="-360px";var f=function(){var b=""===a.style.left?0:parseInt(a.style.left);(b-=30)>=d?(a.style.left=b+"px",requestAnimationFrame(f)):e=!1},g=function(){var b=""===a.style.left?0:parseInt(a.style.left);(b+=20)<=0?(a.style.left=b+"px",requestAnimationFrame(g)):e=!0};document.body.addEventListener("click",function(a){e&&a.clientX>=360&&requestAnimationFrame(f)}),document.body.addEventListener("mousemove",function(a){a.clientX<=30&&!e&&(console.log(a.clientX),requestAnimationFrame(g))});var h=function(a){a.className="hide"===a.className?"show":"hide"};c.parentNode.firstElementChild.addEventListener("click",function(){h(c)}),b.parentNode.firstElementChild.addEventListener("click",function(){h(b)})}(),function(){function a(a){console.log(A);var b=A.setting,c=A.music,d=null,e=b.getPlaying(),f=b.getPlaying(),g=c.getLength();if(a!==r.NEXT&&a!==r.PREV&&"string"==typeof a){var h=c.getByName(a);return d=h.value,b.setPlaying(h.index),d}switch(a){case r.NEXT:f=(f+1)%g;break;case r.PREV:f=f?(f-1)%g:g-1}switch(b.setPlaying(f),b.getMode()){case"random":var h=c.getByRandom();d=h.value,b.setPlaying(h.index);break;case"repeat":b.setPlaying(e),d=c.getByIndex(e);break;case"repeatAll":d=c.getByIndex(f)}return d}function b(b){var c=a(b);playingItemInList(),console.log(c),reader=new FileReader,reader.readAsDataURL(c),d.innerText="载入中...",n.innerText="",m.innerText="",reader.onerror=function(){console.log("error")},reader.onload=function(){h.src=reader.result},ID3.loadTags(c.name,function(){for(var a=ID3.getAllTags(c.name),b=a.picture,f="",g=0;g<b.data.length;g++)f+=String.fromCharCode(b.data[g]);e.src="data:"+b.format+";base64,"+window.btoa(f),e.parentElement.style.display="initial",stackBlurImage("albumPic","canvas",180,!1),t&&k.removeChild(t),t=document.createTextNode('.bg{background-image:url("'+j.toDataURL()+'")}'),k.appendChild(t),d.innerText="",n.innerText=a.title,m.innerText=a.artist},{tags:["artist","title","album","year","comment","track","genre","lyrics","picture"],dataReader:FileAPIReader(c)}),s=!1}var c=document.getElementById("text"),d=document.getElementById("info"),e=document.getElementById("albumPic"),f=document.getElementById("time"),g=document.getElementById("fraction"),h=document.getElementById("audio"),i=document.getElementById("control"),j=(document.getElementById("changeStatus"),document.getElementById("canvas")),k=document.createElement("style"),l=document.getElementsByTagName("head")[0],m=document.createElement("label"),n=document.createElement("label"),o=document.getElementById("color"),p=!1,q=!1,r={NEXT:"NEXT",PREV:"PREV"},s=!1,t=null,u=new Progressbar("#progress"),v=null,w=null,x=null,y=function(){s||(v=new AudioContext,w=v.createMediaElementSource(h),x=v.createAnalyser(),w.connect(x),x.connect(v.destination),s=!0,b(),u.unlock(),m.className="artist",n.className="title",c.appendChild(n),c.appendChild(document.createElement("br")),c.appendChild(m))},z=null,A=load(function(){console.log("load",A),A.music.getLength()>0&&y(),z=function(a){var b=null,c=0,d=0;if(a.preventDefault(),"drop"==a.type&&a.dataTransfer.files.length)for(b=a.dataTransfer.files,d=b.length;d>c;)"audio/mp3"==b[c].type&&A.music.add(b[c],function(){s||(y(),s=!0)}),c++},document.body.addEventListener("dragenter",z),document.body.addEventListener("dragover",z),document.body.addEventListener("drop",z),addListeners(document.getElementById("list").children,function(){b(this.innerText)})}),B=document.getElementById("spectrum"),C=B.offsetWidth,D=B.offsetHeight-2,E=5,F=2,G=2,H="#56FFF6",I=C/(E+F),J=[],K=B.getContext("2d"),L=0,M=function(){var a=new Uint8Array(x.frequencyBinCount);x.getByteFrequencyData(a);var b=Math.round(a.length/(I+I/6));K.clearRect(0,0,C,D);for(var c=0;I>c;c++){var d=a[c*b];J.length<Math.round(I)&&J.push(d),K.fillStyle=H,d<J[c]?K.fillRect(c*(E+F),D- --J[c],E,G):(K.fillRect(c*(E+F),D-d,E,G),J[c]=d),K.fillStyle=A.setting.getThemeColor(),K.fillRect(c*(E+F),D-d+G,E,D)}L=requestAnimationFrame(M)},N=function(){var a=document.createAttribute("width");a.value=document.body.offsetWidth+"px",B.attributes.setNamedItem(a),C=B.offsetWidth,I=C/(E+F),console.log(B.width,document.body.offsetWidth)};N(),u.lock(),k.type="text/css",l.appendChild(k),window.addEventListener("resize",N),document.body.addEventListener("mousewheel",function(a){a.clientX<=360||(h.volume=a.wheelDelta>0?h.volume+.1>1?1:h.volume+.1:h.volume-.1<0?0:h.volume-.1)}),o.addEventListener("change",function(){{var a=A.setting;A.music}console.log(this.value),a.setThemeColor(this.value)}),i.addEventListener("click",function(a){var c=a.target,d=c.localName;if("span"==d&&s)switch(c.className){case"glyphicon glyphicon-play":h.play(),c.className="glyphicon glyphicon-pause",e.classList.remove("paused"),e.classList.add("running");break;case"glyphicon glyphicon-pause":h.pause(),c.className="glyphicon glyphicon-play",e.classList.remove("running"),e.classList.add("paused");break;case"glyphicon glyphicon-backward":b(r.PREV);break;case"glyphicon glyphicon-forward":b(r.NEXT)}}),h.addEventListener("play",function(){L=requestAnimationFrame(M)}),h.addEventListener("pause",function(){cancelAnimationFrame(L)}),h.addEventListener("loadedmetadata",function(){cancelAnimationFrame(L)}),h.addEventListener("canplay",function(){s=!0}),h.addEventListener("ended",function(){b(r.NEXT)}),changeMode.addEventListener("click",function(){console.log(this.title);var a={"列表循环":"repeatAll","随机播放":"random","单曲循环":"repeat"};setMode(a[this.title])}),u.on("pressBar",function(){console.log("pressBar"),h.currentTime=u.getPosition()*h.duration}),u.on("startDraggingFlag",function(){console.log("startDraggingFlag"),q=!0,p=!0}),u.on("stopDraggingFlag",function(){console.log("stopDraggingFlag"),q&&0!=h.currentTime&&(h.currentTime=u.getPosition()*h.duration,p=!1,q=!1)}),h.addEventListener("timeupdate",function(){var a=A.setting,b=A.music,c=h.duration,d=h.currentTime;p||u.setPosition(d/c),c=parseInt(c/60)+":"+parseInt(c%60),d=parseInt(d/60)+":"+parseInt(d%60),f.innerText=d+" / "+c,g.innerText=a.getPlaying()+1+" / "+b.getLength()})}();